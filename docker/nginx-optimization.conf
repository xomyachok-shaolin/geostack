# Оптимизированная конфигурация nginx для geokiosk.ru
# Добавить в секцию server для geokiosk.ru

# Включить HTTP/2 для параллельных запросов (до 100 запросов по одному соединению)
# listen 443 ssl http2;  # Уже должно быть

# Оптимизация для 3D моделей (b3dm файлы)
location ~* \.(b3dm|glb|gltf|cmpt|pnts|i3dm)$ {
    proxy_pass http://geostack;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Агрессивное кэширование (30 дней) - модели не меняются
    expires 30d;
    add_header Cache-Control "public, immutable, max-age=2592000";
    
    # Увеличенные буферы для 3D файлов (могут быть до 50MB)
    proxy_buffer_size 256k;
    proxy_buffers 8 512k;
    proxy_busy_buffers_size 512k;
    
    # Отключаем буферизацию для стриминга больших файлов
    proxy_buffering off;
    
    # Поддержка Range запросов (для частичной загрузки)
    proxy_set_header Range $http_range;
    proxy_set_header If-Range $http_if_range;
    
    # Gzip для JSON (tileset.json)
    gzip on;
    gzip_types application/json;
}

# Оптимизация для tileset.json - кэшируем меньше (может обновляться)
location ~* tileset\.json$ {
    proxy_pass http://geostack;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Кэширование на 1 час
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
    
    # Gzip обязательно для JSON
    gzip on;
    gzip_types application/json;
    gzip_min_length 100;
}

# Keepalive для повторного использования соединений
upstream geostack {
    server geostack:3000;
    keepalive 32;  # Пул keepalive соединений
}

# В секции server добавить:
# proxy_http_version 1.1;
# proxy_set_header Connection "";

# === РЕКОМЕНДАЦИИ ДЛЯ ОБЩИХ НАСТРОЕК HTTP ===
# Добавить в секцию http {}:
#
# # Увеличить лимиты для параллельных соединений
# worker_connections 4096;  # Вместо 1024
#
# # Включить sendfile для статики
# sendfile on;
# tcp_nopush on;
# tcp_nodelay on;
#
# # Увеличить таймауты
# keepalive_timeout 65;
# keepalive_requests 1000;
#
# # Буферы для больших файлов
# client_body_buffer_size 128k;
# client_max_body_size 100m;
#
# # Open file cache
# open_file_cache max=10000 inactive=60s;
# open_file_cache_valid 120s;
# open_file_cache_min_uses 2;
# open_file_cache_errors on;
